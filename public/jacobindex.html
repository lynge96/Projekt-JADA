<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <script src="scripts/d3.js"></script>
  <title>JADA datavisualisering #1</title>

  <style type="text/css">
    svg {
      background-color: rgb(39, 39, 39);
      border: 2px solid black;
    }

    .y-axis {
      stroke-width: 2px;
      color: rgb(122, 122, 122);
      font-size: 15px;
      opacity: 0;
    }

    .x-axis {
      stroke-width: 2px;
      color: rgb(122, 122, 122);
      font-size: 15px;
    }
  </style>

</head>

<body>
  <h1>Co2 emission</h1>

  <!-- Lav knapper til datasortering -->
  <button id="CO2Country">CO2 country 1</button>
  <button id="CO2Capita">CO2 capita</button>

  <input type="checkbox" class="checkboxLande" value="Denmark" checked>
  <label value="Denmark">Denmark</label>

  <input type="checkbox" class="checkboxLande" value="China">
  <label value="China">China</label>

  <input type="checkbox" class="checkboxLande" value="Japan">
  <label value="Japan">Japan</label>

  <input type="checkbox" class="checkboxLande" value="United States">
  <label value="Japan">United States</label>

  <input type="checkbox" class="checkboxLande" value="EU-27">
  <label value="Japan">EU-27</label>

  <input type="checkbox" class="checkboxLande" value="Russia">
  <label value="Japan">Russia</label>

  <input type="checkbox" class="checkboxLande" value="Brazil">
  <label value="Japan">Brazil</label>

  <input type="checkbox" class="checkboxLande" value="Germany">
  <label value="Japan">Germany</label>


  <script>
    // Denne query kører op imod API'en som findes i 'main.js'.
    // Denne HTML skal derfor åbnes igennem serveren for at virke.
    d3.json("/api/co2country", {
      method: "POST",
    }).then(function (response) {
      const data1 = response.data; // Hent data ud af response

      d3.json("/api/co2capita", {
        method: "POST",
      }).then(function (response) {
        const data2 = response.data; // Hent data ud af response

        // Definér SVG størrelse og padding
        const w = 750;
        const h = 600;
        const padding = 80;

        // Lav SVG element
        const svg = d3.select("body")
          .append("svg")
          .attr("width", w)
          .attr("height", h)

        // Lav en skala for x-aksen og append den
        let x = d3.scaleLinear()
          .range([padding, w - padding])
          .domain([d3.min(data1, function (d) { return d.year }), d3.max(data1, function (d) { return d.year; })]);

        let xAxis = d3.axisBottom()
          .scale(x)
          .tickFormat(function (d) { return parseInt(d, 10) })
          .ticks(7);

        svg.append("g")
          .attr("class", "x-axis")
          .attr("transform", "translate(0, " + (h - padding) + ")")
          .transition()
          .duration(1000)
          .call(xAxis)

        // Lav en skala for y-aksen
        let y = d3.scaleLinear()
          .range([h - padding, padding]);
        let yAxis = d3.axisLeft()
          .scale(y)
        svg.append("g")
          .attr("class", "y-axis")
          .attr("transform", "translate(" + (padding) + ",0)")

         // Farvescale til linjerne, så de har hver deres
         const farvescale = d3.scaleOrdinal()
              .domain(["Denmark", "China", "Japan", "United States", "EU-27", "Russia", "Brazil", "Germany"])
              .range(["#1331B4", "#081332", "#137D90", "#6C4120", "#DA24AC", "#D219E4", "#A9E8B7", "#D50236"])
        // Kør update(data) med datasæt 1, som tegner grafen
        update(data1)

        // Lav function til at lave grafen og sortere i dataen
        function update(data) {

          // Laver array med de valgte lande fra checkboxene
          let choices = [];

          d3.selectAll(".checkboxLande")
            .on("change", updateBox);
          updateBox();

          function updateBox() {
            d3.selectAll(".checkboxLande")
              .each(function (d) {
                cb = d3.select(this);
                if (cb.property("checked")) {
                  switch (cb.property("value")) {
                    case choices[0]:
                      break;
                    case choices[1]:
                      break;
                    case choices[2]:
                      break;
                    case choices[3]:
                      break;
                    case choices[4]:
                      break;
                    case choices[5]:
                      break;
                    case choices[6]:
                      break;
                    case choices[7]:
                      break;
                    default:
                      choices.push(cb.property("value"))
                  }
                } else {
                  switch (cb.property("value")) {
                    case choices[0]:
                      choices.splice(0, 1)
                      break;
                    case choices[1]:
                      choices.splice(1, 1)
                      break;
                    case choices[2]:
                      choices.splice(2, 1)
                      break;
                    case choices[3]:
                      choices.splice(3, 1)
                      break;
                    case choices[4]:
                      choices.splice(4, 1)
                      break;
                    case choices[5]:
                      choices.splice(5, 1)
                      break;
                    case choices[6]:
                      choices.splice(6, 1)
                      break;
                    case choices[7]:
                      choices.splice(7, 1)
                      break;
                  }
                }
              });

            // Logger hvilket choices der ligger i array'et
            console.log("Choices:" + choices)

            if (choices.length > 0) {
              for (i = 0; i < choices.length; i++) {
                newData = data.filter(function (row) {
                  return (row.lokation == choices[0]) + (row.lokation == choices[1]) + (row.lokation == choices[2]) + (row.lokation == choices[3]) + (row.lokation == choices[4]) + (row.lokation == choices[5]) + (row.lokation == choices[6]) + (row.lokation == choices[7])
                }
                )
              }
            } else {
              newData = [];
            }

            // Laver domain på y-aksen alt afhængig af hvilket datasæt, der er valgt - laver herefter y-aksen
            y.domain([0, d3.max(newData, function (d) { return parseFloat(d.co2); })])
            svg.selectAll(".y-axis")
              .transition()
              .duration(1000)
              .call(yAxis);

            // Lav datagrupperinger - én linje per land
            const sumstat = d3.group(newData, d => d.lokation);
            console.log(sumstat)
           

            // Lav grafen
            svg.selectAll(".line")
              .data(sumstat)

            // Laver opdaterings konstanter til grafen og labels
            const updateGraphs = svg.selectAll(".lines")
              .data(sumstat)

            const updatestatsLabels = svg.selectAll("text.statsLabels")
              .data(sumstat)

            const updatecountryLabels = svg.selectAll("text.countryLabels")
              .data(sumstat)

            updateGraphs
              .enter()
              .append("path")
              .attr("class", "lines")
              .merge(updateGraphs)
              .attr("d", function (d) {
                return d3.line()
                  .x(function (d) { return x(d.year); })
                  .y(function (d) { return y(parseFloat(d.co2)); })
                  (d[1])
              })
              .attr("fill", "none")
              .attr("stroke", function (d, i) {
                return farvescale(choices[i])
              })
              .attr("stroke-width", 3)
              .attr("stroke-dasharray", 1000)
              .attr("stroke-dashoffset", 1000)
              .transition() // Call Transition Method
              .duration(1000) // Set Duration timing (ms)
              .ease(d3.easeLinear) // Set Easing option
              .attr("stroke-dashoffset", 0);

            // Fjerner de linjer, som ikke længere skal med
            updateGraphs
              .exit()
              .remove()

            // Indsætter labels for statistik
            updatestatsLabels
              .enter()
              .append("text")
              .attr("class", "statsLabels") // Husk at sætte class på
              .merge(updatestatsLabels)
              .text(function (d, i) { // Her laves teksten til en label
                return parseFloat((sumstat.get(choices[i])[30].co2))
              })
              // Labels x og y svarer til punktets x og y
              .attr("x", function (d) {
                return x(d3.max(newData, function (d) { return parseFloat(d.year) }))
              })
              .attr("y", function (d, i) {
                return y(parseFloat((sumstat.get(choices[i])[30].co2)))
              })
              .attr("stroke", function (d, i) {
                return farvescale(choices[i])
              });

            // Fjerner de gamle
            updatestatsLabels
              .exit()
              .remove();

            // Indsætter labels for hvert land
            updatecountryLabels
              .enter()
              .append("text")
              .attr("class", "countryLabels") // Husk at sætte class på
              .merge(updatecountryLabels)
              .text(function (d, i) { // Her laves teksten til en label
                return choices[i]
              })
              // Labels x og y svarer til punktets x og y
              .attr("x", function (d) {
                return (x(d3.min(newData, function (d) { return parseFloat(d.year) })) - 70)
              })
              .attr("y", function (d, i) {
                return y(parseFloat((sumstat.get(choices[i])[0].co2)))
              })
              .attr("fill", function (d, i) {
                return farvescale(choices[i])
              });

            // Fjerner de gamle
            updatecountryLabels
              .exit()
              .remove();

          }
        };

        // CO2country/capita knapper der ændrer hvilket datasæt vi kigger på
        d3.selectAll("#CO2Country, #CO2Capita")
          .on("click", function (e) {
            // Find hvilken knap der blev trykket på
            const id = e.target.id;
            console.log(id);
            if (id === "CO2Country") {
              update(data1);
            } else if (id === "CO2Capita") {
              update(data2)
            }
          });
      });
    });


  </script>
</body>

</html>