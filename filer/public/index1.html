<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <script src="scripts/d3.js"></script>
  <title>Anders er super kongen</title>

  <style type="text/css">
    svg {
      background-color: rgb(39, 39, 39);
      border: 2px solid black;
    }

    .y-axis {
      stroke-width: 2px;
      color: rgb(122, 122, 122);
      font-size: 15px;
    }

    .x-axis {
      stroke-width: 2px;
      color: rgb(122, 122, 122);
      font-size: 15px;
    }
  </style>

</head>

<body>
  <h1>Data is beautiful</h1>

  <!-- Lav knapper til datasortering -->
  <button id="Co2Country">CO2 country 1</button>
  <button id="Co2Capita">CO2 capita</button>
  <input type="checkbox" class="checkboxLande" value="Denmark">
  <input type="checkbox" class="checkboxLande" value="China">
  <input type="checkbox" class="checkboxLande" value="Japan">



  <script>
    // Denne query kører op imod API'en som findes i 'main.js'.
    // Denne HTML skal derfor åbnes igennem serveren for at virke.
    d3.json("/api/co2country", {
      method: "POST",
    }).then(function (response) {
      const data1 = response.data; // Hent data ud af response

      d3.json("/api/co2capita", {
        method: "POST",
      }).then(function (response) {
        const data2 = response.data; // Hent data ud af response

        // Lav checkbox sortering
        table = d3.select("#content")
          .append("table")
          .property("border", "1px");


        // Definér SVG størrelse og padding
        const w = 750;
        const h = 600;
        const padding = 80;


        // Lav SVG element
        const svg = d3.select("body")
          .append("svg")
          .attr("width", w)
          .attr("height", h)

        // Lav en skala for x-aksen og append den
        let x = d3.scaleLinear()
          .range([padding, w - padding])
          .domain([d3.min(data1, function (d) { return d.year }), d3.max(data1, function (d) { return d.year; })]);

        let xAxis = d3.axisBottom()
          .scale(x)
          .tickFormat(function (d) { return parseInt(d, 10) })
          .ticks(7);

        svg.append("g")
          .attr("class", "x-axis")
          .attr("transform", "translate(0, " + (h - padding) + ")")
          .transition()
          .duration(1000)
          .call(xAxis)



        // Lav en skala for y-aksen
        let y = d3.scaleLinear()
          .range([h - padding, padding]);
        let yAxis = d3.axisLeft()
          .scale(y)
        svg.append("g")
          .attr("class", "y-axis")
          .attr("transform", "translate(" + (padding) + ",0)")

        // Checkbox funktionalitet 

        d3.selectAll(".checkboxLande")
          .on("change", updatebox);

        function updatebox(data) {
          let choices = [];
          d3.selectAll(".checkboxLande")
            .each(function (d) {
              cb = d3.select(this);
              if (cb.property("checked")) {
                choices.push(cb.property("value"));
              }
            });

          if (data == data1) {
            if (choices.length > 0) {
              newData = data1.filter(function (row) {
                return row.lokation == choices;
              });
            }
          }
          else if (data == data2) {
            if (choices.length > 0) {
              newData = data2.filter(function (row) {
                return row.lokation == choices;
              });
            } else {
              newData = data2;
            }
          }

          update(newData)
          console.log(choices)
        }

        // Lav function til at sortere data
        function update(data) {

          y.domain([0, d3.max(data, function (d) { return parseFloat(d.co2); })])
          svg.selectAll(".y-axis")
            .transition()
            .duration(1000)
            .call(yAxis);

          // Lav datagrupperinger - én linje per land
          const sumstat = d3.group(data, d => d.lokation);

          // Tilfældig farve
          let farvescale = d3.scaleOrdinal()
            .range(["#1331B4", "#081332", "#137D90", "#6C4120", "#DA24AC", "#D219E4", "#A9E8B7", "#D50236", "#2C2E04", "#35CFC6", "#687644", "#AC1DFE", "#D58FE1", "#886A68", "#30E341", "#D90B18", "#F25FCA", "#A177A5", "#DC6869", "#32C857", "#7DDB22", "#8585E2", "#30597F"]);

          // Lav grafen
          const updatedata = svg.selectAll(".line")
            .data(sumstat)

          updatedata
            .enter()
            .append("path")
            .attr("class", "line")
            .attr("d", function (d) {
              return d3.line()
                .x(function (d) { return w / 2 })
                .y(function (d) { return h})
                (d[1])
            })
            .merge(updatedata)
            .transition()
            .duration(1000)
            .attr("d", function (d) {
              return d3.line()
                .x(function (d) { return x(d.year); })
                .y(function (d) { return y(parseFloat(d.co2)); })
                (d[1])
            })
            .attr("fill", "none")
            .attr("stroke", function (d, i) {
              return farvescale([i])
            })
            .attr("stroke-width", 4);


          updatedata
            .exit()
            .remove()
        };

        d3.selectAll("#Co2Country, #Co2Capita")
          // Koden herunder køres kun ved tryk på knappen
          .on("click", function (e) {
            // Find hvilken knap der blev trykket på
            const id = e.target.id;
            console.log(id);

            if (id === "Co2Country") {
              updatebox(data1);
            } else if (id === "Co2Capita") {
              updatebox(data2)
            }
          });

      });
    });


  </script>
</body>

</html>


